<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>LoL ë‚´ì „ íˆ¬í‘œ</title>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore-compat.js"></script>
  <style>
    body { font-family: Arial; padding: 20px; }
    .time-grid { display: flex; gap: 10px; margin: 20px 0; flex-wrap: wrap; }
    .checkbox-cell { padding: 10px; border: 1px solid #ccc; min-width: 80px; cursor: pointer; }
    .checkbox-cell input { transform: scale(1.2); }
    .user-list button {
      margin: 5px;
      padding: 8px 12px;
      font-size: 14px;
    }
    .selected-user { font-weight: bold; color: green; }
  </style>
</head>
<body>
  <h1>LoL ë‚´ì „ ì‹œê°„ëŒ€ íˆ¬í‘œ</h1>
  <p id="todayDate" style="font-weight: bold; color: #555;">ğŸ“… ì˜¤ëŠ˜ ë‚ ì§œ: </p>
  <p>ì´ë¦„ì„ ì„ íƒí•˜ê³  ê°€ëŠ¥í•œ ì‹œê°„ëŒ€ë¥¼ ì²´í¬í•˜ì„¸ìš”:</p>

  <div class="user-list" id="userList"></div>
  <div><strong>ì„ íƒëœ ì‚¬ëŒ:</strong> <span id="currentUser" class="selected-user">ì—†ìŒ</span></div>

  <div class="time-grid" id="timeGrid"></div>

  <button onclick="submitAvailability()">ì €ì¥í•˜ê¸°</button>
  <button onclick="showResults()">ê²°ê³¼ ë³´ê¸°</button>
  <button onclick="clearAvailability()">ğŸ—‘ï¸ ìê¸° ë°ì´í„°ë§Œ ì´ˆê¸°í™”</button>

  <h2>ëª¨ë“  ê²°ê³¼:</h2>
<!-- ğŸ§¨ ì „ì²´ ì´ˆê¸°í™” ë²„íŠ¼ -->
<p id="lastResetTime" style="color: gray;">ğŸ”„ ë§ˆì§€ë§‰ ì´ˆê¸°í™” ì‹œê°„: ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>
<div style="margin-top: 20px; text-align: center;">
  <button style="background-color: #dc3545;" onclick="resetAllData()">ğŸ§¨ ì „ì²´ ë°ì´í„° ì´ˆê¸°í™”</button>
</div>

  <pre id="results"></pre>

  <script>
    // âœ… [ì—¬ê¸°ì— Firebase ì„¤ì • ë¶™ì—¬ë„£ê¸°]
    const firebaseConfig = {
      apiKey: "AIzaSyA72WFh7CDmLKLUMoR2Ws1H-IH612aS4jE",
      authDomain: "lol-vote-f9dd0.firebaseapp.com",
      projectId: "lol-vote-f9dd0",
      storageBucket: "lol-vote-f9dd0.firebasestorage.app",
      messagingSenderId: "43337092856",
      appId: "1:43337092856:web:b8784d8015c192df83350d",
      measurementId: "G-4D9S9JGLSH"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    // ì°¸ê°€ì ëª©ë¡ê³¼ ì‹œê°„ëŒ€
    const users = ["ì¤€ì˜", "ë¯¼ì„­", "ì§„ê´€", "ì¤€í˜¸", "íœ˜ê·¼", "ì—¬ì¤€", "ì¬í™˜", "ê²½í•™", "ì£¼í˜„", "íœ˜ì¤€", "ì›ìš©", "ì¬ì°½", "ì˜ì¤€", "ê·¼ë¡", "íƒœí˜„", "ì¬í˜"];
    const hours = ["18", "19", "20", "21", "22", "23"];
    let selectedUser = null;

    const userListDiv = document.getElementById("userList");
    const timeGrid = document.getElementById("timeGrid");
    const currentUserSpan = document.getElementById("currentUser");

    // ì‚¬ìš©ì ë²„íŠ¼ ë§Œë“¤ê¸°
    users.forEach(name => {
      const btn = document.createElement("button");
      btn.textContent = name;
      btn.onclick = () => selectUser(name);
      userListDiv.appendChild(btn);
    });

    function createGrid() {
  timeGrid.innerHTML = "";
  
  hours.forEach(hour => {
    const cell = document.createElement("div");
    cell.className = "checkbox-cell";
    const checkbox = document.createElement("input");
    checkbox.type = "checkbox";
    checkbox.id = `hour-${hour}`;
    checkbox.className = "time-checkbox"; // í´ë˜ìŠ¤ ì¶”ê°€
    cell.appendChild(checkbox);
    cell.appendChild(document.createTextNode(` ${hour}ì‹œ`));
    timeGrid.appendChild(cell);
  });

  // ğŸ”¹ ë¶ˆì°¸ ì²´í¬ë°•ìŠ¤ ì¶”ê°€
  const absentCell = document.createElement("div");
  absentCell.className = "checkbox-cell";
  const absentCheckbox = document.createElement("input");
  absentCheckbox.type = "checkbox";
  absentCheckbox.id = "absent";
  absentCell.appendChild(absentCheckbox);
  absentCell.appendChild(document.createTextNode(" âŒ ë¶ˆì°¸"));
  timeGrid.appendChild(absentCell);

  // âœ… ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ: ë¶ˆì°¸ ì²´í¬ ì‹œ ë‚˜ë¨¸ì§€ ì‹œê°„ ì²´í¬ í•´ì œ & ë¹„í™œì„±í™”
  absentCheckbox.addEventListener("change", () => {
    const disabled = absentCheckbox.checked;
    document.querySelectorAll(".time-checkbox").forEach(cb => {
      cb.checked = false;
      cb.disabled = disabled;
    });
  });
}



    createGrid();
    // ì˜¤ëŠ˜ ë‚ ì§œ í‘œì‹œ
    const today = new Date();
    const yyyy = today.getFullYear();
    const mm = String(today.getMonth() + 1).padStart(2, '0');
    const dd = String(today.getDate()).padStart(2, '0');
    const formattedDate = `${yyyy}-${mm}-${dd}`;
    document.getElementById("todayDate").textContent = `ğŸ“… ì˜¤ëŠ˜ ë‚ ì§œ: ${formattedDate}`;

    const dayNames = ['ì¼', 'ì›”', 'í™”', 'ìˆ˜', 'ëª©', 'ê¸ˆ', 'í† '];
    const day = dayNames[today.getDay()];
    document.getElementById("todayDate").textContent = `ğŸ“… ì˜¤ëŠ˜ ë‚ ì§œ: ${formattedDate} (${day}ìš”ì¼)`;


    function selectUser(name) {
      selectedUser = name;
      currentUserSpan.textContent = name;
      loadAvailability();
    }

    async function loadAvailability() {
  if (!selectedUser) return;
  const doc = await db.collection("votes").doc(selectedUser).get();
  const data = doc.exists ? doc.data() : {};

  const isAbsent = data["absent"] || false;
  document.getElementById("absent").checked = isAbsent;

  document.querySelectorAll(".time-checkbox").forEach(cb => {
    const hour = cb.id.split("-")[1];
    cb.checked = data[hour] || false;
    cb.disabled = isAbsent;
  });
}


    async function submitAvailability() {
      if (!selectedUser) {
        alert("ì´ë¦„ì„ ì„ íƒí•˜ì„¸ìš”.");
        return;
      }  

      const availability = {};
      hours.forEach(hour => {
        const id = `hour-${hour}`;
        availability[hour] = document.getElementById(id).checked;
      });
      availability["absent"] = document.getElementById("absent").checked;
      await db.collection("votes").doc(selectedUser).set(availability);
      alert(`${selectedUser}ë‹˜ì˜ ì‹œê°„ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.`);
      

    }
    async function clearAvailability() {
      if (!selectedUser) {
        alert("ì‚¬ìš©ìë¥¼ ë¨¼ì € ì„ íƒí•˜ì„¸ìš”.");
        return;
      }

      const confirmed = confirm(`${selectedUser}ë‹˜ì˜ ì‹œê°„ëŒ€ë¥¼ ì´ˆê¸°í™”í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`);
      if (!confirmed) return;

      await db.collection("votes").doc(selectedUser).delete();

      // ì²´í¬ë°•ìŠ¤ ì „ë¶€ í•´ì œ
      hours.forEach(hour => {
        document.getElementById(`hour-${hour}`).checked = false;
      });

      alert(`${selectedUser}ë‹˜ì˜ ë°ì´í„°ê°€ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤.`);
    }

    async function resetAllData() {
  const confirmed = confirm("âš ï¸ ëª¨ë“  ì°¸ê°€ìì˜ ë°ì´í„°ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?");
  if (!confirmed) return;

  const snapshot = await db.collection("votes").get();
  const batch = db.batch();

  snapshot.forEach(doc => {
    batch.delete(doc.ref);
  });

  await batch.commit();

  // ğŸ”¸ ë§ˆì§€ë§‰ ì´ˆê¸°í™” ì‹œê°„ ì €ì¥
  await db.collection("meta").doc("lastReset").set({
    timestamp: firebase.firestore.FieldValue.serverTimestamp()
  });

  alert("ì „ì²´ ë°ì´í„°ê°€ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤.");
  document.getElementById("results").textContent = "";

  // ğŸ”¹ í™”ë©´ì—ë„ ë°”ë¡œ ë°˜ì˜
  updateLastResetDisplay();
}



async function showResults() {
  const snapshot = await db.collection("votes").get();
  const votesByHour = {};
  let absentees = []; // âŒ ë¶ˆì°¸ì ì €ì¥ìš© ë°°ì—´

  snapshot.forEach(doc => {
    const name = doc.id;
    const data = doc.data();

    // âœ… ë¶ˆì°¸ì ì²˜ë¦¬
    if (data["absent"]) {
      absentees.push(name);
      return; // ë¶ˆì°¸ì´ë©´ ì‹œê°„ëŒ€ ì²´í¬ëŠ” ë¬´ì‹œ
    }

    // ì‹œê°„ëŒ€ë³„ ì²˜ë¦¬
    for (const hour in data) {
      if (data[hour] && hour !== "absent") {
        if (!votesByHour[hour]) votesByHour[hour] = [];
        votesByHour[hour].push(name);
      }
    }
  });

  const sorted = Object.entries(votesByHour).sort((a, b) => b[1].length - a[1].length);
  let resultText = "";

  sorted.forEach(([hour, names]) => {
    resultText += `${hour}ì‹œ: ${names.length}ëª… (${names.join(", ")})\n`;
  });

  // âœ… ë¶ˆì°¸ì ì¶œë ¥
  if (absentees.length > 0) {
    resultText += `\nâŒ ë¶ˆì°¸ì (${absentees.length}ëª…): ${absentees.join(", ")}\n`;
  }

  document.getElementById("results").textContent = resultText || "ì•„ì§ ë°ì´í„° ì—†ìŒ.";
}

async function updateLastResetDisplay() {
  const doc = await db.collection("meta").doc("lastReset").get();
  if (!doc.exists) {
    document.getElementById("lastResetTime").textContent = "ğŸ”„ ë§ˆì§€ë§‰ ì´ˆê¸°í™” ì‹œê°„: ì—†ìŒ";
    return;
  }

  const ts = doc.data().timestamp;
  if (ts && ts.toDate) {
    const date = ts.toDate();
    const formatted = `${date.getFullYear()}-${(date.getMonth()+1).toString().padStart(2, "0")}-${date.getDate().toString().padStart(2, "0")} ${date.getHours().toString().padStart(2, "0")}:${date.getMinutes().toString().padStart(2, "0")}`;
    document.getElementById("lastResetTime").textContent = `ğŸ”„ ë§ˆì§€ë§‰ ì´ˆê¸°í™” ì‹œê°„: ${formatted}`;
  } else {
    document.getElementById("lastResetTime").textContent = "ğŸ”„ ë§ˆì§€ë§‰ ì´ˆê¸°í™” ì‹œê°„: ì•Œ ìˆ˜ ì—†ìŒ";
  }
}

// í˜ì´ì§€ ë¡œë“œì‹œ ë¶ˆëŸ¬ì˜¤ê¸°
updateLastResetDisplay();



  </script>
</body>
</html>
